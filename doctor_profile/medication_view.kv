#: import spinner_with_arrow auxiliary_classes.spinner_with_arrow

<MedicationsView>:
    # This view will show only if NO patient is selected
    BoxLayout:
        opacity: 1 if not root.current_patient_user else 0
        disabled: False if not root.current_patient_user else True
        Label:
            text: 'Selecione um paciente para ver os detalhes.'
            font_size: '14sp'
            color: 0.3, 0.3, 0.3, 1

    # This view will show content only if a patient is selected
    ScrollView:
        opacity: 1 if root.current_patient_user else 0
        disabled: False if root.current_patient_user else True
        auto_scroll: False
        # This is the main container for the entire scrollable content
        BoxLayout:
            orientation: 'vertical'
            padding: dp(10)
            spacing: dp(10)
            size_hint_y: None
            height: self.minimum_height # This makes the layout grow with its content

            # [R014] The GridLayout itself now acts as the visual container for the list
            GridLayout:
                id: medications_list
                cols: 1
                size_hint_x: 1
                size_hint_y: None
                height: self.minimum_height
                padding: dp(10)
                spacing: dp(5)
                # The background is now handled by each MedicationItem
 
            # [R014] Bottom area for operations
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                padding: dp(10)
                spacing: dp(10)

                # Container to center the search input field
                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: generic_name_input
                        hint_text: 'Busque a Medicação (ex: Paracetamol)'
                        size_hint: 0.8, 1
                        pos_hint: {'center_x': 0.5}
                        multiline: False
                        font_size: '12sp'
                        on_text: root.filter_generic_medications(self.text)

                # Search results container - using a BoxLayout to avoid nested ScrollView issues
                BoxLayout:
                    id: med_search_results_scroll
                    size_hint_y: None
                    height: 0 # Initially hidden
                    GridLayout:
                        id: med_search_results
                        cols: 1
                        size_hint_y: None
                        height: self.minimum_height

                # Grid for detailed medication inputs
                GridLayout:
                    cols: 2
                    spacing: dp(10)
                    size_hint_y: None
                    height: self.minimum_height

                    SpinnerWithArrow:
                        id: presentation_input
                        text: 'Apresentação'
                        values: ['Comprimido', 'Cápsula', 'Solução Oral', 'Injetável', 'Adesivo', 'Outro']

                    TextInput:
                        id: dosage_input
                        hint_text: 'Dosagem (ex: 50mg)'
                        size_hint_y: None
                        multiline: False # Keep single line for dosage
                        font_size: '13sp'
                        height: dp(48)

                    TextInput:
                        id: quantity_input
                        hint_text: 'Quantidade (ex.: 1 comprimido, 20 gotas etc.)'
                        size_hint_y: None
                        font_size: '13sp'
                        multiline: True # Allow multiline input
                        height: dp(64) # Increased height
                        on_text: root.prevent_newlines(self)
                    
                    BoxLayout:
                        spacing: dp(10)
                        SpinnerWithArrow:
                            id: hour_spinner
                            text: 'Hora'
                            values: root.hour_list

                        SpinnerWithArrow:
                            id: minute_spinner
                            text: 'Min'
                            values: root.minute_list



                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(5)

                    Label:
                        text: 'Dias:'
                        color: 0,0,0,1
                        size_hint_y: None
                        height: self.texture_size[1]
                        halign: 'left'
                        padding: [dp(5), 0]

                    # Checkboxes for days of the week
                    BoxLayout:
                        size_hint_y: None
                        height: dp(30)
                        spacing: dp(4)
                        padding: [dp(5), 0]
                        # "Select All" Checkbox
                        CheckBox:
                            id: day_all
                            size_hint_x: None
                            width: dp(24)
                            color: 0,0,0,1
                            on_active: root.toggle_all_days(self.active)
                        Label:
                            text: '#'
                            color: 0,0,0,1
                        # Individual Day Checkboxes
                        CheckBox:
                            id: day_seg
                            color: 0,0,0,1
                            on_active: root.update_select_all_status()
                            size_hint_x: None
                            width: dp(24)
                        Label:
                            text: 'S' # Segunda
                            color: 0,0,0,1
                            font_size: '12sp'
                        CheckBox:
                            id: day_ter
                            color: 0,0,0,1
                            on_active: root.update_select_all_status()
                            size_hint_x: None
                            width: dp(24)
                        Label:
                            text: 'T' # Terça
                            color: 0,0,0,1
                            font_size: '12sp'
                        CheckBox:
                            id: day_qua
                            color: 0,0,0,1
                            on_active: root.update_select_all_status()
                            size_hint_x: None
                            width: dp(24)
                        Label:
                            text: 'Q' # Quarta
                            color: 0,0,0,1
                            font_size: '12sp'
                        CheckBox:
                            id: day_qui
                            color: 0,0,0,1
                            on_active: root.update_select_all_status()
                            size_hint_x: None
                            width: dp(24)
                        Label:
                            text: 'Q' # Quinta
                            color: 0,0,0,1
                            font_size: '12sp'
                        CheckBox:
                            id: day_sex
                            color: 0,0,0,1
                            on_active: root.update_select_all_status()
                            size_hint_x: None
                            width: dp(24)
                        Label:
                            text: 'S' # Sexta
                            color: 0,0,0,1
                            font_size: '12sp'
                        CheckBox:
                            id: day_sab
                            color: 0,0,0,1
                            on_active: root.update_select_all_status()
                            size_hint_x: None
                            width: dp(24)
                        Label:
                            text: 'S' # Sábado
                            color: 0,0,0,1
                            font_size: '12sp'
                        CheckBox:
                            id: day_dom
                            color: 0,0,0,1
                            on_active: root.update_select_all_status()
                            size_hint_x: None
                            width: dp(24)
                        Label:
                            text: 'D' # Domingo
                            color: 0,0,0,1
                            font_size: '12sp'


                TextInput:
                    id: observation_input
                    hint_text: 'Observações para o genérico (opcional)'
                    size_hint_y: None
                    font_size: '13sp'
                    height: dp(96) # A altura pode ser ajustada se necessário
                    on_text: root.enforce_text_limit(self, 300)

                Button:
                    # This button is only visible in "add" mode
                    opacity: 1 if not root.editing_med_id else 0
                    disabled: True if root.editing_med_id else False
                    text: 'Adicionar Medicação'
                    size_hint_y: None
                    height: dp(48)
                    on_press: root.add_medication()

                BoxLayout:
                    # These buttons are only visible in "edit" mode
                    opacity: 1 if root.editing_med_id else 0
                    disabled: False if root.editing_med_id else True
                    size_hint_y: None
                    height: dp(48) if root.editing_med_id else 0
                    Button:
                        text: 'Salvar Alteração'
                        on_press: root.save_medication_edit()
                    Button:
                        text: 'Cancelar'
                        on_press: root.cancel_edit()

<MedicationItem>:
    size_hint_y: None
    height: self.minimum_height # Altura dinâmica