#: import spinner_with_arrow auxiliary_classes.spinner_with_arrow

<PatientEvolutionView>:
    # Message shown when no patient is selected
    BoxLayout:
        opacity: 1 if not root.current_patient_email else 0
        disabled: False if not root.current_patient_email else True
        Label:
            text: 'Selecione um paciente para registrar a evolução.'
            font_size: '14sp'
            color: 0.3, 0.3, 0.3, 1
            halign: 'center'

    # Main content, shown when a patient is selected
    BoxLayout:
        orientation: 'vertical'
        opacity: 1 if root.current_patient_email else 0
        disabled: False if root.current_patient_email else True
        canvas.before:
            Color:
                rgba: 0.95, 0.95, 0.95, 1
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Date Selection Container
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            padding: dp(10)
            spacing: dp(5)

            Label:
                text: 'Selecione a Data:'
                color: 0,0,0,1
                size_hint_y: None
                height: self.texture_size[1]
                halign: 'left'

            BoxLayout:
                orientation: 'horizontal'
                spacing: dp(10)
                size_hint_y: None
                height: dp(48)

                TextInput:
                    id: day_input
                    hint_text: 'Dia'
                    input_filter: 'int'
                    multiline: False
                    on_text: root.enforce_text_limit(self, 2); root.on_date_selected()

                SpinnerWithArrow:
                    id: month_spinner
                    text: 'Mês'
                    values: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro']
                    on_text: root.on_date_selected()

                SpinnerWithArrow:
                    id: year_spinner
                    text: 'Ano'
                    values: root.year_list
                    on_text: root.on_date_selected()

            Button:
                text: 'Preencher com a data de hoje'
                size_hint_y: None
                height: dp(40)
                font_size: '13sp'
                on_press: root.fill_today_date()


        # Area for dynamic metric inputs
        ScrollView:
            GridLayout:
                id: metrics_grid
                cols: 1
                padding: [dp(10), dp(30), dp(10), dp(10)] # Added top padding
                spacing: dp(10)
                size_hint_y: None
                height: self.minimum_height

        # Save Button
        BoxLayout:
            size_hint_y: None
            height: dp(60)
            padding: dp(10)
            Button:
                text: 'Salvar Dados do Dia'
                on_press: root.save_evolution_data()

        # Graph Generation Area
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            padding: [dp(10), dp(20), dp(10), dp(10)] # Top padding
            spacing: dp(10)

            Label:
                text: 'Gerar Relatório:'
                color: 0,0,0,1
                size_hint_y: None
                height: self.texture_size[1]
                halign: 'left'

            SpinnerWithArrow:
                id: metric_graph_spinner
                text: 'Selecione a Métrica'
                font_size: '12sp'
                values: root.graph_metric_list
            
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: dp(48)
                spacing: dp(10)
                Button:
                    text: 'Últimos 7 dias'
                    font_size: '13sp'
                    disabled: metric_graph_spinner.text == 'Selecione a Métrica'
                    on_press: root.generate_report(7)
                Button:
                    text: 'Últimos 30 dias'
                    font_size: '13sp'
                    disabled: metric_graph_spinner.text == 'Selecione a Métrica'
                    on_press: root.generate_report(30)